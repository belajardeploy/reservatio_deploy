name: Pull Reservasi FE Automation (PRODUCTION)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 200
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        with:
          command_timeout: 200m
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "Starting deployment for branch: ${{ github.ref }}"

            # Load nvm and node environment
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

            nvm use 18

          
            echo "Deploying to PRODUCTION..."
            DEPLOY_DIR="/var/www/reservasi-fe"
            GIT_BRANCH="main"

            cd $DEPLOY_DIR
            git fetch origin
            git reset --hard origin/$GIT_BRANCH

            echo "Installing npm dependencies..."
            npm install

            echo "Building the project..."
            npm run build

            echo "Deleting pm2 process..."
            pm2 delete reservasi-fe || true

            echo "Starting pm2 process..."
            PORT=4010 pm2 start npm --name reservasi-fe -- run start

            echo "Listing pm2 processes..."
            pm2 list

            echo "Saving pm2 processes..."
            pm2 save

            echo "Deployment completed successfully for $GIT_BRANCH."



